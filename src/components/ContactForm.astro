---
import { Image } from 'astro:assets';
import katie from '@/assets/avatar.jpg';
import Heading from './ui/Heading.astro';
---

<section aria-label='Contact Form' class='relative' id='contact'>
  <div data-pattern></div>
  <div class='form-wrapper'>
    <Image
      src={katie}
      alt='Katie Haus'
      class='headshot'
      width='700'
      format='avif'
    />
    <form id='contact-form'>
      <Heading tagName='h2' size='h2'>Let's Connect!</Heading>
      <p>Reach out below for inquiries, quotes, or collaborations.</p>
      <div class='input-wrapper'>
        <label for='name'>Name</label>
        <input
          type='text'
          id='name'
          name='name'
          placeholder='e.g. Katie Haus'
          required
        />
      </div>
      <div class='input-wrapper'>
        <label for='name'>E-Mail</label>
        <input
          type='email'
          id='email'
          name='email'
          placeholder='e.g. hi@email.com'
          required
        />
      </div>
      <button type='submit' class='btn primary'>Contact Me</button>
      <p class='message'></p>
    </form>
  </div>
</section>

<script>
  const contactForm = document.querySelector(
    '#contact-form',
  ) as HTMLFormElement;
  const messageParagraph = document.querySelector(
    '.message',
  ) as HTMLFormElement;

  const updateMessage = (message: string, type: 'error' | 'success') => {
    messageParagraph.classList.add(type);
    messageParagraph.textContent = message;
    setTimeout(() => {
      messageParagraph.textContent = '';
      messageParagraph.classList.remove(type);
    }, 3000);
  };

  contactForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(contactForm);
    const { name, email } = Object.fromEntries(formData);

    // More validation
    if (!name || typeof name !== 'string' || name.length < 3) {
      return updateMessage('Please enter a valid name.', 'error');
    }
    if (!email || typeof email !== 'string' || !email.includes('@')) {
      return updateMessage('Please enter a valid e-mail.', 'error');
    }
    try {
      const res = await fetch('http://localhost:3000/contacts', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name, email }),
      });
      if (!res.ok) {
        throw new Error('Failed to send message. Please try again later.');
      }
      contactForm.reset();
      return updateMessage('Thanks for reaching out!', 'success');
    } catch (e) {
      if (e instanceof Error) {
        console.error(e.message);
        return updateMessage(e.message, 'error');
      }
      return updateMessage(
        'Something went wrong. Please try again later.',
        'error',
      );
    }
  });
</script>
